(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4680],{47293:function(e,t,i){"use strict";i.r(t),i.d(t,{OwncastPlayer:function(){return OwncastPlayer}});var n=i(85893),s=i(67294),r=i(4480),a=i(46977),l=i(94184),o=i.n(l),h=i(4511),c=i(85215),u=i(56987),d=i.n(u);i(45621);let VideoJS=e=>{let{options:t,onReady:i}=e,r=s.useRef(null),a=s.useRef(null);return s.useEffect(()=>{var e;if(!a.current){let e=r.current,n=a.current=(0,c.Z)(e,t,()=>(console.debug("player is ready"),i&&i(n,c.Z)));n.autoplay(t.autoplay),n.src(t.sources)}(null===(e=c.Z.getPlayer(r.current).tech({IWillNotUseThisInPlugins:!0}))||void 0===e?void 0:e.vhs)&&(c.Z.getPlayer(r.current).tech({IWillNotUseThisInPlugins:!0}).vhs.xhr.beforeRequest=e=>{if(e.uri.match("m3u8")){let t=Math.random().toString(16).substr(2,8);e.uri="".concat(e.uri,"?cachebust=").concat(t)}return e})},[t,r]),(0,n.jsx)("div",{"data-vjs-player":!0,children:(0,n.jsx)("video",{ref:r,className:"video-js vjs-big-play-centered vjs-show-big-play-button-on-pause ".concat(d().player," vjs-owncast")})})};function ping(){try{fetch("/api/ping")}catch(e){console.error(e)}}let ViewerPing=class ViewerPing{start(){this.stop(),this.timer=setInterval(()=>{ping()},4e3)}stop(){clearInterval(this.timer)}};let g={position:"absolute",width:"100%",height:"100%"},CrossfadeImage=e=>{let{src:t="",width:i,height:r,objectFit:a="fill",duration:l="1s",className:o}=e,h=(0,s.useMemo)(()=>({display:"inline-block",position:"relative",width:i,height:r}),[i,r]),c=(0,s.useMemo)(()=>[{...g,objectFit:a,opacity:0,transition:"opacity ".concat(l)},{...g,objectFit:a,opacity:1,transition:"opacity ".concat(l)},{...g,objectFit:a,opacity:0}],[a,l]),[u,d]=(0,s.useState)(0),[m,p]=(0,s.useState)(["",""]),y=t!==m[1]?t:"",onLoadImg=()=>{d((u+1)%3),p([m[1],y])};return(0,n.jsx)("span",{style:h,className:o,children:[...m,y].map((e,t)=>""!==e&&(0,n.jsx)("img",{src:e,alt:"",style:c[t],onLoad:2===t?onLoadImg:void 0},e))})};CrossfadeImage.defaultProps={objectFit:"fill",duration:"3s"};var m=i(46368),p=i.n(m);let VideoPoster=e=>{let t,{online:i,initialSrc:r,src:a}=e,[l,o]=(0,s.useState)(r),[h,c]=(0,s.useState)("0s");return(0,s.useEffect)(()=>{clearInterval(t),t=setInterval(()=>{"0s"===h&&c("3s"),o("".concat(a,"?").concat(Date.now()))},2e4)},[]),(0,n.jsxs)("div",{className:p().poster,children:[!i&&(0,n.jsx)("img",{src:r,alt:"logo"}),i&&(0,n.jsx)(CrossfadeImage,{src:l,duration:h,objectFit:"contain",height:"auto",width:"100%",className:p().image})]})};var y=i(55157),f=i(73580);function getCurrentlyPlayingSegment(e){let t;let i=e.vhs.playlists.media(),n=e.currentTime();for(let e=0,s=i.segments.length;e<s;e++)if(n<i.segments[e].end){t=i.segments[e];break}return t||([t]=i.segments),t}let PlaybackMetrics=class PlaybackMetrics{stop(){clearInterval(this.sendMetricsTimer),this.player.off()}setClockSkew(e){this.clockSkewMs=e}videoJSReady(){let e=this.player.tech({IWillNotUseThisInPlugins:!0});this.supportsDetailedMetrics=!!e,null==e||e.on("usage",e=>{"vhs-unknown-waiting"===e.name&&this.setIsBuffering(!0),"vhs-rendition-change-abr"===e.name&&this.incrementQualityVariantChanges()});let t=this.player.textTracks();t.addEventListener("cuechange",()=>{this.incrementQualityVariantChanges()})}handlePlaying(){clearInterval(this.collectPlaybackMetricsTimer),this.collectPlaybackMetricsTimer=setInterval(()=>{this.collectPlaybackMetrics()},5e3)}handleEnded(){clearInterval(this.collectPlaybackMetricsTimer)}handleBuffering(){this.incrementErrorCount(1),this.setIsBuffering(!0)}handleNoLongerBuffering(){this.setIsBuffering(!1)}handleError(){this.incrementErrorCount(1)}incrementErrorCount(e){this.errors+=e}incrementQualityVariantChanges(){if(!this.hasPerformedInitialVariantChange){this.hasPerformedInitialVariantChange=!0;return}this.qualityVariantChanges++}setIsBuffering(e){if(this.isBuffering=e,!e){clearTimeout(this.bufferingDurationTimer);return}this.bufferingDurationTimer=setTimeout(()=>{this.incrementErrorCount(1)},500)}trackSegmentDownloadTime(e){this.segmentDownloadTime.push(e)}trackBandwidth(e){this.bandwidthTracking.push(e)}trackLatency(e){this.latencyTracking.push(e)}collectPlaybackMetrics(){let e=this.player.tech({IWillNotUseThisInPlugins:!0});if(!e||!e.vhs||this.player.paused())return;let t=this.player.networkState();if(2!==t)return;let i=e.vhs.systemBandwidth;this.trackBandwidth(i);try{let t=getCurrentlyPlayingSegment(e);if(!t||!t.dateTimeObject)return;let i=t.dateTimeObject.getTime(),n=new Date().getTime()+this.clockSkewMs,s=n-i;if(s<0||s/1e3>=100)return;this.trackLatency(s)}catch(e){console.warn(e)}}async send(){let e;if(0===this.segmentDownloadTime.length||!this.player||this.player.paused())return;let t=this.errors;if(this.supportsDetailedMetrics){let average=e=>e.reduce((e,t)=>e+t,0)/e.length,i=average(this.segmentDownloadTime)/1e3,n=average(this.bandwidthTracking)/1e3,s=average(this.latencyTracking)/1e3;e={bandwidth:Math.round(1e3*n)/1e3,latency:Math.round(1e3*s)/1e3,downloadDuration:Math.round(1e3*i)/1e3,errors:t+(this.isBuffering?1:0),qualityVariantChanges:this.qualityVariantChanges}}else e={errors:t+(this.isBuffering?1:0)};this.errors=0,this.qualityVariantChanges=0,this.segmentDownloadTime=[],this.bandwidthTracking=[],this.latencyTracking=[];let i={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)};try{await fetch("/api/metrics/playback",i)}catch(e){console.error(e)}}constructor(e,t){var i=this;this.player=e,this.supportsDetailedMetrics=!1,this.hasPerformedInitialVariantChange=!1,this.clockSkewMs=0,this.segmentDownloadTime=[],this.bandwidthTracking=[],this.latencyTracking=[],this.errors=0,this.qualityVariantChanges=0,this.isBuffering=!1,this.bufferingDurationTimer=0,this.collectPlaybackMetricsTimer=0,this.videoJSReady=this.videoJSReady.bind(this),this.handlePlaying=this.handlePlaying.bind(this),this.handleBuffering=this.handleBuffering.bind(this),this.handleEnded=this.handleEnded.bind(this),this.handleError=this.handleError.bind(this),this.send=this.send.bind(this),this.collectPlaybackMetrics=this.collectPlaybackMetrics.bind(this),this.handleNoLongerBuffering=this.handleNoLongerBuffering.bind(this),this.sendMetricsTimer=0,this.player.on("canplaythrough",this.handleNoLongerBuffering),this.player.on("error",this.handleError),this.player.on("stalled",this.handleBuffering),this.player.on("waiting",this.handleBuffering),this.player.on("playing",this.handlePlaying),this.player.on("ended",this.handleEnded);let n=t.xhr;t.Vhs.xhr=function(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];if(t[0].uri.match(".ts")){let e=new Date,n=t[1];t[1]=(t,s,r)=>{let a=new Date,l=a.getTime()-e.getTime();i.trackSegmentDownloadTime(l),n(t,s,r)}}return n(...t)},this.videoJSReady(),this.sendMetricsTimer=setInterval(()=>{this.send()},1e4)}};function createVideoSettingsMenuButton(e,t,i,n){let s=t.getComponent("MenuItem"),r=t.getComponent("MenuItem"),a=t.getComponent("MenuButton");let MenuSeparator=class MenuSeparator extends s{createEl(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"button",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=super.createEl(e,t,i);return n.innerHTML='<hr style="opacity: 0.3; margin-left: 10px; margin-right: 10px;" />',n}constructor(e,t){super(e,t)}};let l=new r(e,{selectable:!0,label:"minimize latency (experimental)"});l.on("click",()=>{let e=n();l.selected(e)});let o=new MenuSeparator(e,{selectable:!1});let MenuButton=class MenuButton extends a{createItems(){let t=e.tech({IWillNotUseThisInPlugins:!0}),n=new r(e,{selectable:!0,selected:!0,label:"Auto"}),s=Array(i.length);i.forEach(t=>{s[t.index]=new r(e,{selectable:!0,label:t.name})});for(let e=0;e<s.length;e+=1){let i=s[e];i.on("click",()=>{if(!t){console.warn("Invalid attempt to access null player tech");return}t.vhs.representations().forEach((t,i)=>{let n=i===e;t.enabled(n),s[i].selected(n)}),n.selected(!1)})}n.on("click",()=>{t.vhs.representations().forEach(e=>{e.enabled(!0)}),s.forEach(e=>e.selected(!1)),n.selected(!0)});let a=!!t&&!!t.vhs;return i.length<2&&a?[l]:i.length>1&&a?[n,...s,o,l]:a||1!==i.length?[n,...s]:[]}constructor(){super(e)}};let h=new MenuButton;return h.el().setAttribute("aria-label","Settings"),h.addClass("vjs-quality-selector"),t.registerComponent("MenuButton",MenuButton),h}function latencyCompensator_getCurrentlyPlayingSegment(e){let t;let i=e.vhs.playlists.media(),n=e.currentTime();for(let e=0,s=i.segments.length;e<s;e++)if(n<i.segments[e].end){t=i.segments[e];break}return t||([t]=i.segments),t}let LatencyCompensator=class LatencyCompensator{setClockSkew(e){this.clockSkewMs=e}check(){if(new Date().getTime()-this.startupTime.getTime()<1e4||this.player.paused()||this.player.seeking()||this.inTimeout||!this.enabled)return;let e=this.player.tech({IWillNotUseThisInPlugins:!0});if(!e||!e.vhs)return;let t=this.player.networkState();if(2!==t)return;let i=0;try{if(0===e.vhs.stats.buffered.length){this.timeout();return}e.vhs.stats.buffered.forEach(e=>{i+=e.end-e.start})}catch(e){console.error(e)}let n=e.vhs.playlists.media(),s=n.attributes.BANDWIDTH,r=e.vhs.systemBandwidth,a=r/s;try{let t=latencyCompensator_getCurrentlyPlayingSegment(e);if(!t)return;if(a<1.8&&i<6*t.duration){this.timeout();return}let n=Math.max(4e3,1e3*t.duration*1.8),s=this.bufferedAtLatency.concat([n]),r=s.reduce((e,t)=>e+t,0)/s.length,l=Math.max(1.4*r,Math.min(1e3*t.duration*2.6,15e3));r>=l&&(l=r+3e3);let o=t.dateTimeObject.getTime(),h=new Date().getTime()+this.clockSkewMs,c=h-o;if(this.currentLatency=c,Math.abs(c)>8e4){this.timeout();return}if(c>l){if(this.shouldJumpToLive()&&c>l+5e3){let i=c/1e3-3*t.duration,n=this.player.currentTime()+i;console.info("latency",c/1e3,"jumping",i,"to live from ",this.player.currentTime()," to ",n);let s=e.vhs.stats.buffered[0].end,r=e.vhs.stats.buffered[0].start;if(n>r<s){this.jump(n);return}}let i=.33*a;(i=Math.max(Math.min(i,1.08),1))>this.playbackRate+.02&&(i=this.playbackRate+.02),i=Math.round(1e3*i)/1e3,this.start(i)}else c<=r&&this.stop();console.info("latency",c/1e3,"min",r/1e3,"max",l/1e3,"playback rate",this.playbackRate,"enabled:",this.enabled,"running: ",this.running,"skew: ",this.clockSkewMs,"rebuffer events: ",this.bufferingCounter)}catch(e){}}shouldJumpToLive(){if(this.bufferingCounter>1)return!1;let e=new Date().getTime(),t=e-this.lastJumpOccurred;return t>2e4}jump(e){this.jumpingToLiveIgnoreBuffer=!0,this.performedInitialLiveJump=!0,this.lastJumpOccurred=new Date,console.info("current time",this.player.currentTime(),"seeking to",e),this.player.currentTime(e),setTimeout(()=>{this.jumpingToLiveIgnoreBuffer=!1},5e3)}setPlaybackRate(e){this.playbackRate=e,this.player.playbackRate(e)}start(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;!this.inTimeout&&this.enabled&&e!==this.playbackRate&&(this.running=!0,this.setPlaybackRate(e))}stop(){this.running&&console.log("stopping latency compensator..."),this.running=!1,this.setPlaybackRate(1)}enable(){this.enabled=!0,clearInterval(this.checkTimer),clearTimeout(this.bufferingTimer),this.checkTimer=setInterval(()=>{this.check()},3e3)}disable(){clearInterval(this.checkTimer),clearTimeout(this.timeoutTimer),this.stop(),this.enabled=!1}timeout(){this.jumpingToLiveIgnoreBuffer||(this.inTimeout=!0,this.stop(),clearTimeout(this.timeoutTimer),this.timeoutTimer=setTimeout(()=>{this.endTimeout()},3e4))}endTimeout(){clearTimeout(this.timeoutTimer),this.inTimeout=!1}handlePlaying(){let e=this.playing;this.playing=!0,clearTimeout(this.bufferingTimer),this.enabled&&this.shouldJumpToLive()&&(e||(this.jumpingToLiveIgnoreBuffer=!0,this.player.liveTracker.seekToLiveEdge(),this.lastJumpOccurred=new Date))}handlePause(){this.playing=!1}handleEnded(){this.enabled&&this.disable()}handleError(){this.enabled&&this.timeout()}countBufferingEvent(){if(this.bufferingCounter+=1,this.bufferingCounter>4){this.disable();return}this.bufferedAtLatency.push(this.currentLatency),console.log("latency compensation timeout due to buffering:",this.bufferingCounter,"buffering events of",4),setTimeout(()=>{this.bufferingCounter>0&&(this.bufferingCounter-=1)},18e4)}handleBuffering(){if(this.enabled&&!this.inTimeout){if(this.jumpingToLiveIgnoreBuffer){this.jumpingToLiveIgnoreBuffer=!1;return}this.timeout(),clearTimeout(this.bufferingTimer),this.bufferingTimer=setTimeout(()=>{this.countBufferingEvent()},200)}}constructor(e){this.player=e,this.playing=!1,this.enabled=!1,this.running=!1,this.inTimeout=!1,this.jumpingToLiveIgnoreBuffer=!1,this.timeoutTimer=0,this.checkTimer=0,this.bufferingCounter=0,this.bufferingTimer=0,this.playbackRate=1,this.lastJumpOccurred=null,this.startupTime=new Date,this.clockSkewMs=0,this.currentLatency=null,this.bufferedAtLatency=[],this.player.on("playing",this.handlePlaying.bind(this)),this.player.on("pause",this.handlePause.bind(this)),this.player.on("error",this.handleError.bind(this)),this.player.on("waiting",this.handleBuffering.bind(this)),this.player.on("stalled",this.handleBuffering.bind(this)),this.player.on("ended",this.handleEnded.bind(this)),this.player.on("canplaythrough",this.handlePlaying.bind(this)),this.player.on("canplay",this.handlePlaying.bind(this)),this.check=this.check.bind(this),this.start=this.start.bind(this),this.enable=this.enable.bind(this),this.countBufferingEvent=this.countBufferingEvent.bind(this)}};var b=i(46779),v=i.n(b);let VideoSettingsService=class VideoSettingsService{static async getVideoQualities(){let e=[];try{let t=await fetch(VideoSettingsService.VIDEO_CONFIG_URL);e=await t.json()}catch(e){console.error(e)}return e}};VideoSettingsService.VIDEO_CONFIG_URL="/api/video/variants";let T=(0,s.createContext)(VideoSettingsService);var k=i(50057);let w="owncast_volume",C="latencyCompensatorEnabled",P=new ViewerPing,I=null,B=null,S=!1,OwncastPlayer=e=>{let{source:t,online:i,initiallyMuted:l=!1,title:c,className:u}=e,d=(0,s.useContext)(T),g=s.useRef(null),[m,p]=(0,r.FV)(f.We),b=(0,r.sJ)(f.g8),setSavedVolume=()=>{try{g.current.volume((0,y.$o)(w)||1)}catch(e){console.warn(e)}},handleVolume=()=>{(0,y.qQ)(w,g.current.muted()?0:g.current.volume())},togglePlayback=()=>{g.current.paused()?g.current.play():g.current.pause()},startLatencyCompensator=()=>{B&&B.stop(),S=!0,(B=new LatencyCompensator(g.current)).setClockSkew(b),B.enable(),(0,y.qQ)(C,!0)},stopLatencyCompensator=()=>{B&&B.disable(),B=null,S=!1,(0,y.qQ)(C,!1)},toggleLatencyCompensator=()=>(S?stopLatencyCompensator():startLatencyCompensator(),S),setupLatencyCompensator=e=>{let t=e.tech({IWillNotUseThisInPlugins:!0});if(!t||!t.vhs)return;let i=(0,y.$o)(C);"true"===i&&t&&t.vhs?startLatencyCompensator():stopLatencyCompensator()},createSettings=async(e,t)=>{let i=await d.getVideoQualities(),n=createVideoSettingsMenuButton(e,t,i,toggleLatencyCompensator);e.controlBar.addChild(n,{},e.controlBar.children_.length-2),setupLatencyCompensator(e)},setupAirplay=(e,t)=>{if(window.hasOwnProperty("WebKitPlaybackTargetAvailabilityEvent")){let i=t.getComponent("Button");let ConcreteButtonClass=class ConcreteButtonClass extends i{handleClick(){try{let e=document.getElementsByTagName("video")[0];e.webkitShowPlaybackTargetPicker()}catch(e){console.error(e)}}constructor(){super(e)}};let n=new ConcreteButtonClass,s=e.controlBar.addChild(n);s.addClass("vjs-airplay")}};return(0,a.y1)("space",e=>{e.preventDefault(),togglePlayback()}),(0,a.y1)("f",()=>{g.current.isFullscreen()?g.current.exitFullscreen():g.current.requestFullscreen()},{enableOnContentEditable:!1}),(0,a.y1)("m",()=>{g.current.muted()||0===g.current.volume()?g.current.volume(.7):g.current.volume(0)},{enableOnContentEditable:!1}),(0,a.y1)("0",()=>g.current.volume(g.current.volume()+.1),{enableOnContentEditable:!1}),(0,a.y1)("9",()=>g.current.volume(g.current.volume()-.1),{enableOnContentEditable:!1}),(0,s.useEffect)(()=>{I&&I.setClockSkew(b)},[b]),(0,s.useEffect)(()=>()=>{stopLatencyCompensator(),null==I||I.stop()},[]),(0,n.jsx)(h.SV,{fallbackRender:e=>{let{error:t,resetErrorBoundary:i}=e;return(0,n.jsx)(k.A,{componentName:"OwncastPlayer",message:t.message,retryFunction:i})},children:(0,n.jsxs)("div",{className:o()(v().container,u),id:"player",children:[i&&(0,n.jsx)("div",{className:v().player,children:(0,n.jsx)(VideoJS,{options:{autoplay:!1,controls:!0,responsive:!0,fluid:!1,fill:!0,playsinline:!0,liveui:!0,preload:"auto",muted:l,controlBar:{progressControl:{seekBar:!1}},html5:{vhs:{enableLowInitialPlaylist:!0,experimentalBufferBasedABR:!0,useNetworkInformationApi:!0,maxPlaylistRetries:30}},liveTracker:{trackingThreshold:0,liveTolerance:15},sources:[{src:t,type:"application/x-mpegURL"}]},onReady:(e,t)=>{g.current=e,setSavedVolume(),setupAirplay(e,t),e.on("waiting",()=>{console.debug("player is waiting")}),e.on("dispose",()=>{console.debug("player will dispose"),P.stop()}),e.on("playing",()=>{console.debug("player is playing"),P.start(),p(!0)}),e.on("pause",()=>{console.debug("player is paused"),P.stop(),p(!1)}),e.on("ended",()=>{console.debug("player is ended"),P.stop(),p(!1)}),t.hookOnce(),e.on("volumechange",handleVolume),(I=new PlaybackMetrics(e,t)).setClockSkew(b),createSettings(e,t)},"aria-label":c})}),(0,n.jsx)("div",{className:v().poster,children:!m&&(0,n.jsx)(VideoPoster,{online:i,initialSrc:"/thumbnail.jpg",src:"/thumbnail.jpg"})})]})})}},46779:function(e){e.exports={container:"OwncastPlayer_container__CR5Ry",player:"OwncastPlayer_player__dCDjy",poster:"OwncastPlayer_poster__tbpwE"}},56987:function(e){e.exports={player:"VideoJS_player__GD36e"}},46368:function(e){e.exports={poster:"VideoPoster_poster__6rnLj",image:"VideoPoster_image__8kRcw"}},25893:function(){}}]);