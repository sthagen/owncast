"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6959],{44974:function(e,t,n){let a;n.d(t,{me:function(){return Y},FI:function(){return k},Q:function(){return L},L4:function(){return v},j$:function(){return _},ZA:function(){return G},g1:function(){return m},g8:function(){return x},db:function(){return T},ap:function(){return U},di:function(){return P},pT:function(){return V},hz:function(){return M},YW:function(){return j},We:function(){return F},RI:function(){return I},pH:function(){return Z},Gt:function(){return D}});var s,i,o=n(67294),r=n(4480),c=n(99717);let l=(0,o.createContext)(class{static async getConfig(){let e=await fetch("/api/config"),t=await e.json();return t}});var u=n(81453);let d=(0,o.createContext)(class{static async getChatHistory(e){try{let t=await (0,u.$l)("".concat("/api/chat","?accessToken=").concat(e));return t}catch(e){return[]}}static async registerUser(e){let t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({displayName:e})},n=await (0,u.$l)("/api/chat/register",t);return n}});var h=n(28997);class E{createAndConnect(){if(!this.host||this.isShutdown)return;let e=new URL(this.host);e.protocol="https:"===window.location.protocol?"wss:":"ws:",e.pathname="/ws",e.port="3000"===window.location.port?"8080":window.location.port,e.searchParams.append("accessToken",this.accessToken),console.debug("connecting to ",e.toString());let t=new WebSocket(e.toString());t.onopen=this.onOpen.bind(this),t.onerror=this.onError.bind(this),t.onmessage=this.onMessage.bind(this),this.websocket=t}onOpen(){this.websocketReconnectTimer&&clearTimeout(this.websocketReconnectTimer),this.socketConnected()}onError(){console.error("Chat has been disconnected and is likely not working for you. It's possible you were removed from chat. If this is a server configuration issue, visit troubleshooting steps to resolve. https://owncast.online/docs/troubleshooting/#chat-is-disabled"),this.socketDisconnected(),this.websocket.close(),this.isShutdown||this.scheduleReconnect()}scheduleReconnect(){this.isShutdown||(this.websocketReconnectTimer&&clearTimeout(this.websocketReconnectTimer),this.backOff*=2,this.websocketReconnectTimer=setTimeout(this.createAndConnect,5e3+Math.min(this.backOff,1e4)))}shutdown(){this.isShutdown=!0,this.websocket.close()}onMessage(e){let t;let n=e.data.split("\n");for(let e=0;e<n.length;e++){try{t=JSON.parse(n[e]),this.handleMessage&&this.handleMessage(t)}catch(e){console.error(e,e.data);return}if(!t.type){console.error("No type provided",t);return}if(t.type===h.C.PING){this.sendPong();return}}}isConnected(){var e,t;return(null===(e=this.websocket)||void 0===e?void 0:e.readyState)===(null===(t=this.websocket)||void 0===t?void 0:t.OPEN)}send(e){e.type&&h.C[e.type]||console.warn('Outbound message: Unknown socket message type: "'.concat(e.type,'" sent.'));let t=JSON.stringify(e);this.websocket.send(t)}sendPong(){let e={type:h.C.PONG};this.send(e)}constructor(e,t,n){this.isShutdown=!1,this.backOff=1e3,this.accessToken=e,this.path=t,this.websocketReconnectTimer=null,this.isShutdown=!1,this.host=n,this.createAndConnect=this.createAndConnect.bind(this),this.shutdown=this.shutdown.bind(this),this.createAndConnect()}}var f=n(4723);let g={chatAvailable:!0,chatLoading:!1,videoAvailable:!0,appLoading:!1};(s=i||(i={})).Loading="LOADING",s.Loaded="LOADED",s.Online="ONLINE",s.Offline="OFFLINE",s.NeedsRegister="NEEDS_REGISTER",s.Fail="FAIL",s.ChatUserDisabled="CHAT_USER_DISABLED";let p=(0,f.C)({id:"appState",initial:"loading",predictableActionArguments:!0,states:{loading:{meta:{chatAvailable:!1,chatLoading:!1,videoAvailable:!1,appLoading:!0},on:{NEEDS_REGISTER:{target:"loading"},LOADED:{target:"ready"},FAIL:{target:"serverFailure"}}},ready:{initial:"offline",states:{online:{meta:{...g},on:{OFFLINE:{target:"goodbye"},CHAT_USER_DISABLED:{target:"chatUserDisabled"}}},offline:{meta:{chatAvailable:!1,chatLoading:!1,videoAvailable:!1,appLoading:!1},on:{ONLINE:{target:"online"}}},goodbye:{on:{ONLINE:{target:"online"}},meta:{chatAvailable:!0,chatLoading:!1,videoAvailable:!1,appLoading:!1},after:{3e5:{target:"offline"}}},chatUserDisabled:{meta:{...g,chatAvailable:!1}}}},serverFailure:{type:"final"},userfailure:{type:"final"}}});var y=n(61225),C=n(63516),S=function(e,t,n){let{user:a}=e,{id:s,displayName:i,displayColor:o,scopes:r,authenticated:c}=a;t(c),n({id:s.toString(),displayName:i,displayColor:o,isModerator:null==r?void 0:r.includes("MODERATOR")})};let A=(0,o.createContext)(class{static async getStatus(){let e=await fetch("/api/status"),t=await e.json();return t}});var R=function(e,t){t(t=>[...t,e])};r.zl.RECOIL_DUPLICATE_ATOM_KEY_CHECKING_ENABLED=!1;let b="accessToken",w=!1,N=!1,O="Cannot connect to the Owncast service. Please check your internet connection and verify this Owncast server is running.",I=(0,r.cn)({key:"serverStatusState",default:{online:!1,viewerCount:0,serverTime:new Date}}),m=(0,r.cn)({key:"clientConfigState",default:{name:"",summary:"",offlineMessage:"",logo:"",tags:[],version:"",nsfw:!1,extraPageContent:"",socialHandles:[],chatDisabled:!1,externalActions:[],customStyles:"",appearanceVariables:new Map,maxSocketPayloadSize:0,federation:{enabled:!1,account:"",followerCount:0},notifications:{browser:{enabled:!1,publicKey:""}},authentication:{indieAuthEnabled:!1}}}),k=(0,r.cn)({key:"accessTokenAtom",default:null}),T=(0,r.cn)({key:"currentUserAtom",default:null}),_=(0,r.cn)({key:"chatMessages",default:[]}),v=(0,r.cn)({key:"chatAuthenticatedAtom",default:!1}),D=(0,r.cn)({key:"websocketServiceAtom",default:null,dangerouslyAllowMutability:!0}),L=(0,r.cn)({key:"appState",default:{chatAvailable:!1,chatLoading:!0,videoAvailable:!1,appLoading:!0}}),M=(0,r.cn)({key:"isMobileAtom",default:void 0}),G=(0,r.cn)({key:"chatVisibilityToggleAtom",default:!0}),F=(0,r.cn)({key:"isVideoPlayingAtom",default:!1}),U=(0,r.cn)({key:"fatalErrorStateAtom",default:null}),x=(0,r.cn)({key:"clockSkewAtom",default:0}),H=(0,r.cn)({key:"removedMessageIds",default:[]}),P=(0,r.nZ)({key:"isChatAvailableSelector",get:e=>{let{get:t}=e,n=t(L),a=t(k);return a&&n.chatAvailable&&!N}}),V=(0,r.nZ)({key:"isChatVisibleSelector",get:e=>{let{get:t}=e,n=t(L),a=t(G);return n.chatAvailable&&a&&!N}}),j=(0,r.nZ)({key:"isOnlineSelector",get:e=>{let{get:t}=e,n=t(L),a=t(F);return n.videoAvailable||a}}),Z=(0,r.nZ)({key:"visibleChatMessagesSelector",get:e=>{let{get:t}=e,n=t(_),a=t(H);return n.filter(e=>!a.includes(e.id))}}),Y=()=>{let e;let t=(0,o.useContext)(l),n=(0,o.useContext)(d),s=(0,o.useContext)(A),[u,f,g]=(0,c.e)(p),[M,G]=(0,r.FV)(T),F=(0,r.Zl)(v),[P,V]=(0,r.FV)(m),j=(0,r.Zl)(I),Z=(0,r.Zl)(x),Y=(0,r.Zl)(_),[B,J]=(0,r.FV)(k),K=(0,r.Zl)(L),W=(0,r.Zl)(U),z=(0,r.Zl)(D),[X,$]=(0,r.FV)(H),[q,Q]=(0,o.useState)(!1),ee=(e,t)=>{W({title:e,message:t})},et=e=>{f(e)},en=e=>{if(u.matches("loading")){let t=[i.Loaded];e.online?t.push(i.Online):t.push(i.Offline),et(t);return}e.online&&u.matches("ready")?et([i.Online]):e.online||u.matches("ready.offline")||et([i.Offline])},ea=async()=>{try{let e=await t.getConfig();V(e),W(null),Q(!0)}catch(e){ee("Unable to reach Owncast server",O),console.error("ClientConfigService -> getConfig() ERROR: \n",e)}},es=async()=>{try{let e=await s.getStatus();en(e),j(e);let{serverTime:t}=e,n=new Date(t).getTime()-Date.now();Z(n),W(null)}catch(e){et([i.Fail]),ee("Unable to reach Owncast server",O),console.error("serverStatusState -> getStatus() ERROR: \n",e)}},ei=async e=>{let t=(0,y.$o)(b);if(t){J(t);return}try{et([i.NeedsRegister]);let t=await n.registerUser(e),{accessToken:a,displayName:s,displayColor:o}=t;if(!a)return;G({...M,displayName:s,displayColor:o}),J(a),(0,y.qQ)(b,a)}catch(e){et([i.Fail]),console.error("ChatService -> registerUser() ERROR: \n".concat(e))}},eo=()=>{(0,y.qQ)(b,""),J(null),null==e||e.shutdown(),ei()},er=e=>{let{ids:t,visible:n}=e;if(n){let e=X.filter(e=>!t.includes(e));$(e)}else{let e=[...X,...t];$(e)}},ec=()=>{N=!0},el=()=>{N=!1},eu=e=>{switch(e.type){case h.C.ERROR_NEEDS_REGISTRATION:eo();break;case h.C.CONNECTED_USER_INFO:if(S(e,F,G),e){var t;let n=new h.s(e);!w&&(null===(t=n.user)||void 0===t?void 0:t.isModerator())&&(Y(t=>[...t,e]),w=!0)}break;case h.C.CHAT:Y(t=>[...t,e]);break;case h.C.NAME_CHANGE:R(e,Y);break;case h.C.USER_JOINED:Y(t=>[...t,e]);break;case h.C.SYSTEM:Y(t=>[...t,e]);break;case h.C.CHAT_ACTION:Y(t=>[...t,e]);break;case h.C.FEDIVERSE_ENGAGEMENT_FOLLOW:Y(t=>[...t,e]);break;case h.C.FEDIVERSE_ENGAGEMENT_LIKE:Y(t=>[...t,e]);break;case h.C.FEDIVERSE_ENGAGEMENT_REPOST:Y(t=>[...t,e]);break;case h.C.VISIBILITY_UPDATE:er(e);break;case h.C.ERROR_USER_DISABLED:console.log("User has been disabled"),et([i.ChatUserDisabled]);break;default:console.error("Unknown socket message type: ",e.type)}},ed=async()=>{try{let e=await n.getChatHistory(B);e&&Y(t=>[...t,...e])}catch(e){console.error("ChatService -> getChatHistory() ERROR: \n".concat(e))}},eh=async()=>{try{e&&(null==e||e.shutdown(),z(null),e=null);let{socketHostOverride:t}=P,n=window.location;n.hash="";let a=n.toString().replaceAll("#","");(e=new E(B,"/ws",t||a)).handleMessage=eu,e.socketDisconnected=ec,e.socketConnected=el,z(e)}catch(e){console.error("ChatService -> startChat() ERROR: \n".concat(e)),et([i.ChatUserDisabled])}};return(0,o.useEffect)(()=>{try{if(window.configHydration){let e=JSON.parse(window.configHydration);V(e),Q(!0)}}catch(e){console.error("Error parsing config hydration",e)}try{if(window.statusHydration){let e=JSON.parse(window.statusHydration);j(e),en(e)}}catch(e){console.error("error parsing status hydration",e)}},[]),(0,o.useEffect)(()=>{!P.chatDisabled&&B&&q&&!e&&eh()},[q,B]),(0,o.useEffect)(()=>(ea(),ei(),es(),clearInterval(a),a=setInterval(()=>{es()},5e3),()=>{clearInterval(a)}),[]),(0,o.useEffect)(()=>{B&&ed()},[B]),(0,o.useEffect)(()=>{g.onTransition(e=>{let t=(0,C.YR)(e.meta);K(t)})},[]),null}},69183:function(e,t,n){n.d(t,{A:function(){return c}});var a=n(85893),s=n(14670),i=n(71577);let o=()=>{window.open("https://github.com/owncast/owncast/issues/new?assignees=&labels=&template=bug-report-feature-request.yml","_blank")},r=e=>{let{message:t,componentName:n,details:s,canRetry:i}=e;return(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{children:"There was an unexpected error. It would be appreciated if you would report this so it can be fixed in the future."}),!!i&&(0,a.jsx)("p",{children:"You may optionally retry, however functionality might not work as expected."}),(0,a.jsxs)("code",{children:[(0,a.jsx)("div",{children:t&&"Error: ".concat(t)}),(0,a.jsxs)("div",{children:["Component: ",n]}),(0,a.jsx)("div",{children:s&&s})]})]})},c=e=>{let{message:t,componentName:n,details:c,retryFunction:l}=e;return(0,a.jsx)(s.Z,{message:"Error",showIcon:!0,description:(0,a.jsx)(r,{message:t,details:c,componentName:n,canRetry:!!l}),type:"error",action:(0,a.jsxs)(a.Fragment,{children:[l&&(0,a.jsx)(i.Z,{ghost:!0,size:"small",onClick:l,children:"Retry"}),(0,a.jsx)(i.Z,{ghost:!0,size:"small",danger:!0,onClick:o,children:"Report Error"})]})})}},28997:function(e,t,n){n.d(t,{C:function(){return s},s:function(){return o}});var a,s,i=n(25449);(a=s||(s={})).CHAT="CHAT",a.PING="PING",a.NAME_CHANGE="NAME_CHANGE",a.COLOR_CHANGE="COLOR_CHANGE",a.PONG="PONG",a.SYSTEM="SYSTEM",a.USER_JOINED="USER_JOINED",a.CHAT_ACTION="CHAT_ACTION",a.FEDIVERSE_ENGAGEMENT_FOLLOW="FEDIVERSE_ENGAGEMENT_FOLLOW",a.FEDIVERSE_ENGAGEMENT_LIKE="FEDIVERSE_ENGAGEMENT_LIKE",a.FEDIVERSE_ENGAGEMENT_REPOST="FEDIVERSE_ENGAGEMENT_REPOST",a.CONNECTED_USER_INFO="CONNECTED_USER_INFO",a.ERROR_USER_DISABLED="ERROR_USER_DISABLED",a.ERROR_NEEDS_REGISTRATION="ERROR_NEEDS_REGISTRATION",a.ERROR_MAX_CONNECTIONS_EXCEEDED="ERROR_MAX_CONNECTIONS_EXCEEDED",a.VISIBILITY_UPDATE="VISIBILITY-UPDATE";class o{constructor(e){this.id=e.id,this.timestamp=e.timestamp,this.type=e.type,this.body=e.body,e.user&&(this.user=new i.n(e.user))}}},25449:function(e,t,n){n.d(t,{n:function(){return a}});class a{constructor(e){this.isModerator=()=>!!this.scopes&&0!==this.scopes.length&&this.scopes.includes("MODERATOR"),this.id=e.id,this.displayName=e.displayName,this.displayColor=e.displayColor,this.createdAt=e.createdAt,this.previousNames=e.previousNames,this.nameChangedAt=e.nameChangedAt,this.scopes=e.scopes,this.authenticated=e.authenticated}}},63516:function(e,t,n){function a(e,t){return 1===t?e:"".concat(e,"s")}function s(e){let t="string"==typeof e?new Date(e):e;return(new Date-t)/864e5}function i(e){return Object.keys(e).reduce((t,n)=>{let a=e[n];return Object.assign(t,a),t},{})}n.d(t,{Xb:function(){return s},YR:function(){return i},_6:function(){return a}})},61225:function(e,t,n){n.d(t,{$o:function(){return s},dA:function(){return a},qQ:function(){return i}});let a={username:"username",hasDisplayedNotificationModal:"HAS_DISPLAYED_NOTIFICATION_MODAL",userVisitCount:"USER_VISIT_COUNT"};function s(e){try{return localStorage.getItem(e)}catch(e){}return null}function i(e,t){try{return""!==t&&null!==t?localStorage.setItem(e,t):localStorage.removeItem(e),!0}catch(e){}return!1}}}]);